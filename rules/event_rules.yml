version: 1

groups:
  - name: syslog events
    endpoint: /eventlogger/event/fluentd-syslog
    rules:
      - name: Counting errors
        pattern:
          expr: "(?i)error"
          type: regex
        action:
          type: count
          metricName: event_error_count
      - name: Find user logins
        pattern:
          expr: "session opened for user root"
          type: regex
        filter:
          host: elasticvm
          ident: sshd
        action:
          type: alarm
      - name: Count command not found
        pattern:
          expr: "command not found"
          type: regex
        action:
          type: count
          metricName: event_command_not_found_total
      - name: Started Session
        pattern:
          expr: "Started Session \\d+ of user"
          type: regex
        filter:
          ident: "systemd"
        action:
          type: count
          metricName: event_session_started_total
      - name: Connection closed by remote host
        pattern:
          expr: "Connection closed by remote host"
          type: regex
        filter:
          ident: "sshd"
        action:
          type: count
          metricName: event_connection_closed_total

  - name: docker events in syslog
    endpoint: /eventlogger/event/fluentd-syslog
    rules:
      - name: The swarm does not have a leader
        pattern:
          expr: "%{GREEDYDATA}error%{GREEDYDATA}The swarm does not have a leader%{GREEDYDATA}"
          type: grok
        filter:
          ident: "dockerd"
        action:
          type: count
          metricName: event_swarm_no_leader_total
      - name: The swarm does not have a leader alarm
        pattern:
          expr: "%{GREEDYDATA}error%{GREEDYDATA}The swarm does not have a leader%{GREEDYDATA}"
          type: grok
        filter:
          ident: "dockerd"
        action:
          type: alarm

  - name: tailing log files
    endpoint: /eventlogger/event/fluentd-tail
    rules:
      - name: Error counter on fluentd-tail endpoint
        pattern:
          expr: "%{GREEDYDATA}(error|Error|ERROR|Exception)%{GREEDYDATA}"
          type: grok
        action:
          type: count
          metricName: event_fluentd_tail_endpoint_errors_total
      - name: alertmonitor failed to synchronize alarms counter
        pattern:
          expr: "%{GREEDYDATA}SYNCTASK%{GREEDYDATA}failed to synchronize alarms%{GREEDYDATA}"
          type: grok
        filter:
          ident: alertmonitor
        action:
          type: count
          metricName: event_alertmonitor_failed_sync_total

  - name: generic http events
    endpoint: /eventlogger/event/http
    rules:
      - name: Error counter on http endpoint
        pattern:
          expr: "%{GREEDYDATA}(error|Error|ERROR|Exception)%{GREEDYDATA}"
          type: grok
        action:
          type: count
          metricName: event_http_endpoint_errors_total


# actions - ideas
# alarm - send alarm and keep state until cleared
# event - just send without expecting a clear anti-event
# count - count occurrences and expose as Prometheus metric (counter)
# extract - extract value and expose the value as Prometheus metric (gauge)
# log - write event to separate log
# list - show as separated list in gui
# tag - add custom tags
# ignore - ignore event
# kafka - send to kafka topic

